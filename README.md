# Система для асинхронной обработки задач

## Обзор

Эта система выполняет асинхронную обработку задач, поступающих через HTTP-запросы. Она состоит из 4 основных частей:
 - СУБД Redis: используется для хранения данных о задачах, для очередей задач.
 - `server`: Принимает HTTP-запросы на добавление задачи и получения статуса. Сохраняет задачи в Redis, добавляет в очередь на обработку.
 - `worker`: Постоянно ждёт задачи в очереди на обработку (`pending_jobs`), как только она появляется, перемещает в список задач, находящихся в работе (`processing_jobs`). Далее происходит симуляция работы над задачей. Возможны 3 исхода: `failed` - задачу не удалось выполнить, `timeout` - превышено максимальное заданное на выполнение время, `done` - задача успешно выполнена. В зависимости от количества оставшихся попыток на выполнение и результата выполнения `worker` перемещает задачу из `processing_jobs` обратно в `pending_jobs` или просто удаляет её из `processing_jobs`. Также `worker` обновляет данные в Redis о задаче на этапах выполнения и получения результата.
 - `scanner`: Каждые 30 секунд проверяет, нет ли в списке `processing_jobs` задач, которые были добавлены туда слишком давно. Если такие есть, то перемещает их в `pending_jobs`. Это означает, что `worker`, выполнявший задачу, неожиданно завершился. То есть задача `scanner` - следить, чтобы не оставалось задач, "зависших" в списке выполняемых (`processing_jobs`).

 ## Запуск
 Система запускается в Docker. По умолчанию количество `worker` = 3. Это можно изменить в `docker-compose.yaml`. Команда для запуска:
 ```bash
 docker compose up
 ```
 После запуска сервер становится доступен на `localhost:8080`.

 ## API Endpoints
1. **POST `/jobs`**

Создание задачи для обработки. Данные принимаются в формате `json`:
```json
{
    "max_attempts": 3,
    "data": "Calculate smth!",
    "timeout": 2000000000
}
```
`max_attempts` - максимальное количество попыток выполнения задачи, не меньше 1 (по умолчанию 1).

`data` - строка для симуляции выполнения задачи (`worker` выводит её во время выполнения).

`timeout` - максимальное время выполнения задачи в наносекундах. При превышении этого времени во время выполения задача получает статус `timeout`. По умолчанию - 3 секунды.

В случае успеха формат ответа аналогичен формату ответа при запросе на получение статуса задачи (см. ниже), иначе сообщение об ошибке.

2. **GET `/jobs/{job_id}`**

Получение задачи с заданным `id`. Если задачи с таким `id` нет, то ответ: `Job with provided id wasn't found.`

Формат ответа в случае успеха:
```json
{
    "id": 1,
    "attempts_finished": 0,
    "status": "pending",
    "max_attempts": 2,
    "data": "Print document",
    "timeout": 2000000000,
    "time_added": "2020-01-01T00:00:00.000000000Z"
}
```
`attempts_finished` - количество предпринятых попыток выполнения на момент обращения.

`time_added` - время добавления задачи в формате RFC3339Nano.

`status` - текущий статус задачи. 5 вариантов:
 - `pending` - задача в очереди на выполнение (она еще не выполнялась, либо предыдущие попытки не закончились успешно).
 - `processing` - один из `worker`'ов сейчас выполняет эту задачу.
 - `failed` - во время последней попытки неудача.
 - `timeout` - во время последней попытки превышено заданное время выполнения.
 - `done` - задача успешно выполнена.

Последние 3 статуса означают, что задача больше не будет выполняться, так как если задача не закончилась успешно, а попытки остались, то её статус сразу станет `pending`.

`max_attempts`, `data`, `timeout` - заданы при добавлении (POST `/jobs`)